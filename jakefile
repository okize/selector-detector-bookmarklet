var path = require('path'),
    fs = require('fs'),
    uglify = require('uglify-js'),
    filename = 'selector-detector-bookmarklet',
    jsBookmarklet = filename + '-wrapper.js',
    jsScript = filename + '-script.js',
    builddir = './build',
    minfile = filename + '.min.js',
    mapfile = minfile + '.map',
    template = 'index-tmpl.html',
    outfile = 'index.html',
    minified,
    result;

var error = function (err) {
  console.error(err);
};

desc('Create bookmarklet');
task('default', [], function () {

  fs.readFile(template, 'utf8', function (err, data) {

    if (err) { return error(err); }
    minified = uglify.minify(jsBookmarklet);
    result = data.replace('{{replaceMe}}', encodeURI(minified.code).toString());

    fs.writeFile(outfile, result, function (err) {

      if (err) { return error(err); }
      console.log('javascript saved to index.html');

    });

  });

}, true);

desc('Minify script');
task('minify', [], function () {

  minified = uglify.minify(jsScript, {
    outSourceMap: mapfile
  });

  fs.writeFile(path.join(builddir, minfile), minified.code, function (err) {

    if (err) { return error(err); }
    console.log('javascript minified');

  });

  fs.writeFile(path.join(builddir, mapfile), minified.map, function (err) {

    if (err) { return error(err); }
    console.log('javascript source map created');

  });

}, true);