var request = require('request'),
    uglify = require('uglify-js'),
    path = require('path'),
    fs = require('fs'),
    template = 'index-tmpl.html',
    outfile = 'index.html',
    script = 'https://raw.github.com/okize/selector-detector-bookmarklet/master/selector-detector-bookmarklet.js',
    minified,
    result;

var error = function (err) {
  console.error(err);
};

desc('Create bookmarklet');
task('default', [], function () {

  request(script, function (err, response, body) {

    if (err) { return error(err); }

    if (response.statusCode === 200) {

      fs.readFile(template, 'utf8', function (err, data) {

        if (err) { return error(err); }

        minified = uglify.minify(body, { fromString: true });

        result = data.replace('{{replaceMe}}', encodeURI(minified.code).toString());

        fs.writeFile(outfile, result, function (err) {

          if (err) { return error(err); }
          console.log('bookmarklet created in index.html');

        });

      });

    }

  });

}, true);